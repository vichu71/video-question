<!DOCTYPE html>
<html lang="en">

<div id="kopernicaRequired" style="position: absolute; width: 100%;height: 100%">
    <video id="video" playsinline autoplay></video>
    <canvas id="canvas"></canvas>
    <canvas id="mask" style="display: none"></canvas>
    <canvas id="videocanvas" style="display: none"></canvas>
    <canvas id="feedback" style="display: none"></canvas>
    <div id="dot"></div>
    <canvas id="plotting_canvas" style="cursor:crosshair;" width="500" height="500"></canvas>
</div>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name='viewport' content='width=device-width,initial-scale=1.0, viewport-fit=cover'>
    <link rel="icon" href="<%= BASE_URL %>favicon-32x32.png">
    <title>Answer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://es.kopernica.io/js2/kpn_eyetracker.js"></script>
    <script src="https://es.kopernica.io/js2/main.js"></script>
    <script src="https://es.kopernica.io/external/camrectest.js"></script>
</head>
<body>
    <div id="app"></div>
    <script>

        function onEnded(video) {
            console.log('Video ended', video);
            document.dispatchEvent(new CustomEvent("video-ended", { 'detail': { 'bcode': video } }));
        }

        document.addEventListener("start-kopernica", function kop(event) {
            startKopernica(event.detail.user, event.detail.title, "Question", true)
        }, false);

        document.addEventListener("end-kopernica", function kop(event) {
            endRecording();
            var checkIfUploadReady = () => {
                if (imagesSent >= imgArray.length) {
                    document.dispatchEvent(new CustomEvent("upload-progress", { 'detail': { 'progress': imagesSent / imgArray.length } }));
                } else {
                    setTimeout(checkIfUploadReady, 300)
                }
            }
            setTimeout(checkIfUploadReady, 300)
        }, false);

        document.addEventListener("start-gazer", async function gaze() {
            await kpn_eyetracker.setRegression('ridge')
                .setGazeListener(function (data, clock) {
                })
                .begin();

            var setup = function () {
                var canvas = document.getElementById("plotting_canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvas.style.position = 'fixed';
            };

            function checkIfReady() {
                if (kpn_eyetracker.isReady()) {
                    setup();
                    // if(parseInt(goto) > 1){
                    //   console.log("Calibraci�n Reiniciada porque el valor de goto es " + parseInt(goto));
                    kpn_eyetracker.clearData();
                    // } else {
                    //   console.log("Calibraci�n Preservada porque el valor de goto es " + parseInt(goto));
                    // }
                } else {
                    setTimeout(checkIfReady, 100);
                }
            }
            setTimeout(checkIfReady, 100);
        }, false);

        document.addEventListener("start-video-block", function calibration(event) {
            startVideoBlock(event.detail.bcode);
        }, false);

        document.addEventListener("start-question-block", function calibration(event) {
            startQuestionBlock(event.detail.bcode);
        }, false);
    </script>
</body>
<style>
    #video {
        display: block;
        position: fixed;
        height: 24px;
        width: 32px;
        bottom: 0px;
    }

    #canvas {
        display: none;
    }
</style>
</html>
